# step11 实验指导

## 词法语法分析
如果你使用工具完成词法语法分析，修改你的语法规范以满足要求，自行修改词法规范，剩下的交给工具即可。

如果你是手写分析，参见[这里](./manual-parser.md)。

## 名称解析
名称解析没有变化。

另外，step11 引入解引用操作符以后，左值的概念更加复杂，因此需要增加 **左值分析** [^1]，
排除 `1+2=3` 或 `&(1+2)` 这种代码，并且为后续阶段生成左值地址提供信息。
请看[左值文档](./lvalue.md)。
> 左值分析可以放到名称解析中，当然你愿意也可以放到其他阶段或作为一个独立的阶段。

## 类型检查
step11 开始，要增加一个新阶段：**类型检查（type checking）**；它在名称解析和 IR 生成之间。
它用于（一）完成和表达式类型相关的一大类语义检查，例如 11.4 和 11.5；（二）计算表达式的类型信息，提供给后续阶段使用。
这一大类的语义检查互相联系很紧密，所以它们被拿出来单独作为一个阶段。
类型检查的阶段文档请看[类型检查](./typeck.md)
> 当然，指导书上划分的也是逻辑阶段，实现中不必严格遵循。有的助教代码中是 IR 生成和类型检查糅在一起做的。

## IR 生成
无须新增 IR 指令。

新语言特性的支持分别需要
* 对于赋值，和 step5 一样：生成 `=` 右边的值和左边左值的地址，然后 `store`。
* 对于取地址 `&`，生成其操作数左值的地址作为其值。
* 解引用 `*` 的 IR 就是子表达式的 IR 接上一个 `load`。
* 类型转换只对类型检查有用，类型转换表达式的 IR 就是被转换的子表达式的 IR。
    
    > 在实际中，类型转换（cast）可能导致真正的值转换（conversion），例如 `(int) 4.5 == 4` 就需要生成四舍五入的代码。

## 汇编生成
无须修改。

# 任务
1. 首先实现左值分析（无指针的），并通过之前所有测例。
2. 然后搭建类型检查的框架（无指针的），并通过之前所有测例。
3. 最后，加入指针，并且适当修改你的左值分析和类型检查。完整支持本节引入的所有新特性，通过相关测试
4. 实验报告中回答思考题。

# 总结
本节概念不少，代码也相当多，你需要实现左值分析和类型检查。

# 备注
[^1]: 这个名字是我们自己取的，但名称解析（name resolution）以及类型检查（type checking）都是约定俗成的专用术语。
